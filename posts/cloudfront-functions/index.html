<!doctype html><html dir=ltr lang=en data-theme><head><title>Laurynas Tumosa | Modifying AWS Cloudfront response headers with Cloudfront functions</title><meta charset=utf-8><meta name=generator content="Hugo 0.83.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="Notes about Devops, Cloud, AWS, Terraform and other things from my work as a Devops engineer."><link rel=stylesheet href=/css/style.min.7ec96a07e10b60a6997be730fc5d4d3467a225c68515a7df6ae17ac2500f828c.css integrity="sha256-fslqB+ELYKaZe+cw/F1NNGeiJcaFFaffauF6wlAPgow=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=/posts/cloudfront-functions/><script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Modifying AWS Cloudfront response headers with Cloudfront functions"><meta name=twitter:description content="Adding custom HTTP response headers to cloudfront is quite a common task. E.g.: Your website might need a Content-Security-Policy header.
Doing this task in Cloudfront was not easy. You needed to setup a Lambda@Edge function that intercepts response requests and adds the required headers. It's not that difficult to setup Lambda@Edge but using Lambda functions to add a simple HTTP header to a response feels like an overkill. I even wrote about this when the Cloudfront team asked for suggestions: https://t."></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=/images/profile.jpg alt="profile picture"><h3 title><a href=/>DevOps For Humans</a></h3><div class=description><p>Notes about Devops, Cloud, AWS, Terraform and other things from my work as a Devops engineer.</p></div></div></div><ul class=social-links></ul><div class=footer><div class=by_farbox>&copy; Laurynas Tumosa 2021</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/ title>Home</a></li><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>Modifying AWS Cloudfront response headers with Cloudfront functions</h3></div><p>Adding custom HTTP response headers to cloudfront is quite a common task. E.g.: Your website might need a <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy>Content-Security-Policy header</a>.</p><p>Doing this task in Cloudfront was not easy. You needed to setup a Lambda@Edge function that intercepts response requests and adds the required headers. It's not that difficult to setup Lambda@Edge but using Lambda functions to add a simple HTTP header to a response feels like an overkill. I even wrote about this when the Cloudfront team asked for suggestions:<blockquote class=twitter-tweet><p lang=en dir=ltr><a href=https://t.co/BGzCyi8LtU>https://t.co/BGzCyi8LtU</a> headers without needing to use lambda@edge would be great<br>2. Better support for react/angular apps hosted on s3 backend</p>&mdash; Laurynas Tumosa (@LaurynasT2) <a href="https://twitter.com/LaurynasT2/status/1329134380183392256?ref_src=twsrc%5Etfw">November 18, 2020</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script>I was quite surprised when this morning I heard about a new feature called CloudFront Functions. This feature is supposed to make tasks like adding a custom HTTP header simpler. Let's see how it works!</p><h2 id=cloudfront-functions-vs-lambdaedge>Cloudfront Functions vs Lambda@Edge</h2><p>Cloudfront Functions are actually quite similar to Lambda@Edge. The main difference is that Cloudfront Functions run at Cloudfront Edge locations. Wile despite the word <strong>Edge</strong> in Lambda@Eddge it runs at specific AWS regions. Lambda@Edge supports Node.js while Lambda@Edge allows running javascript(ECMAScript 5.1 so <code>let</code> and <code>const</code> keywords are not supported). I'm a bit surprised on why AWS decided to use such old Javascript standard but maybe since the functions are supposed to be lightweight and short it's fine. Since Cloudfront functions run at Cloudfront edge locations and use more lightweight runtime it should be faster than Lambda@Edge. Cloudfront Functions also have some limitations like no network or file system access, limited execution time, etc. Adding a custom response headers doesn't require any of that so let's do that using a Cloudfront function.</p><h2 id=adding-custom-security-header-using-a-cloudfront-function>Adding custom security header using a Cloudfront Function</h2><p>The Cloudfront function that we will build will intercept the response from the Cloudfront origin(s3) and will modify it by adding a content-security-policy header.</p><p>I prefer to use <a href=https://www.terraform.io/>Terraform</a> to define all my AWS resources as code. At this time the feature is not supported yet. However, AWS go sdk already supports Cloudfront Functions so it should be available in Terraform soon. Despite AWS promise to make their services available in AWS Cloudformation from day 1 cloudformation is not supported too. So let's try to create a cloudfront function using AWS console.</p><p>I already have a Cloudfront distribution set up with S3 bucket as origin. Inside S3 bucket I have a simple index.html page. If I run <code>curl</code> command now I can see the following response:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ curl -i d33vf9zl6um5ej.cloudfront.net
HTTP/1.1 <span style=color:#ae81ff>200</span> OK
Content-Type: text/html
Content-Length: <span style=color:#ae81ff>63</span>
Connection: keep-alive
Date: Tue, <span style=color:#ae81ff>04</span> May <span style=color:#ae81ff>2021</span> 16:25:59 GMT
Last-Modified: Tue, <span style=color:#ae81ff>04</span> May <span style=color:#ae81ff>2021</span> 16:24:27 GMT
ETag: <span style=color:#e6db74>&#34;1cf70af742cc5258f37ac61772a0554f&#34;</span>
Accept-Ranges: bytes
Server: AmazonS3
X-Cache: Hit from cloudfront
Via: 1.1 2f7792bdc67f7953e2dce93aea1bb9ee.cloudfront.net <span style=color:#f92672>(</span>CloudFront<span style=color:#f92672>)</span>
X-Amz-Cf-Pop: ARN54-C1
X-Amz-Cf-Id: Vr8Td6stRKhJVAk2rA5XoitG_eKKlm3_TJq-Aob1isHfrF5hQ_HoSQ<span style=color:#f92672>==</span>
Age: <span style=color:#ae81ff>6</span>

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;Hello&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>Let's add a custom Content Security Policy(CSP) header that controls what resources and from where the browser is allowed to load from. It's used for preventing Cross Site Scripting attacks.</p><p>First let's go to Cloudfront Console and create a new function:<figure><img src=/images/cf-1.png><figcaption><h4>Cloudfront Functions Console</h4></figcaption></figure></p><p>Let's give our function a name <code>add-scp-headers</code> and click Continue.</p><p>Now let's replace the example code with this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>event</span>) {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>response</span>;
    <span style=color:#75715e>//add SCP header to the response
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;content-security-policy&#39;</span>] <span style=color:#f92672>=</span> {<span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;default-src &#39;self&#39;&#34;</span>};
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
}
</code></pre></div><p>It simply modifies the cloudfront response and adds the CSP header to the response.</p><p>After clicking save, let's click on the Test tab.</p><p>Since this function modifies requests after they reach origin let's select Viewer response as event type. After clicking test we can see that content-security-policy header is successfully added as a response header.<figure><img src=/images/cf2.png height=500px><figcaption><h4>Cloudfront Function Test</h4></figcaption></figure></p><p>Let's click publish to publish a new version of your function.</p><p>Finally, click Associate, select your distribution Viewer Response as an event type and click add association.<figure><img src=/images/cf3.png><figcaption><h4>Cloudfront Function Association</h4></figcaption></figure></p><p>After using curl on your cloudfront distribution you should receive this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl -i d33vf9zl6um5ej.cloudfront.net
HTTP/1.1 <span style=color:#ae81ff>200</span> OK
Content-Type: text/html
Content-Length: <span style=color:#ae81ff>63</span>
Connection: keep-alive
Date: Tue, <span style=color:#ae81ff>04</span> May <span style=color:#ae81ff>2021</span> 16:25:59 GMT
Last-Modified: Tue, <span style=color:#ae81ff>04</span> May <span style=color:#ae81ff>2021</span> 16:24:27 GMT
Etag: <span style=color:#e6db74>&#34;1cf70af742cc5258f37ac61772a0554f&#34;</span>
Accept-Ranges: bytes
Server: AmazonS3
Via: 1.1 990c1aa70667fe4e8f93d88ac8400fc5.cloudfront.net <span style=color:#f92672>(</span>CloudFront<span style=color:#f92672>)</span>
Content-Security-Policy: default-src <span style=color:#e6db74>&#39;self&#39;</span>
X-Cache: Hit from cloudfront
X-Amz-Cf-Pop: ARN54-C1
X-Amz-Cf-Id: 18gD7OMeCKCE-SieGM2ScxOSTgeBQaSXXYdvQ5L6VvmBXDb8j_s69w<span style=color:#f92672>==</span>

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;Hello&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>It's not a solution what I expected when I tweeted about custom security headers. I thought it could be possible to simply have a section in cloudfront console where you can specify the custom headers without needing to write any Javascript code.</p><p>However, Cloudfront functions is still a more convenient tool than Lambda@Edge if you need to do simple tasks like modifying response or request headers. It's more simple to use and provides simplified debugging, deployment, and monitoring options. I would like to be able to migrate all my Lambda@Edge code to Cloudfront Functions but as of now it's not supported by any infrastructure as a code tool. Personally, I think that having multiple ways to work with Cloudfront(Lambda@Edge and CF Functions) adds some complexity but CF functions looks like a great tool when you don't need full capabilities of Lambda and also provides a nicer developer experience.</p><p>Update:</p><p>I wanted to write this blogpost as I found no resources on how to add security headers using Cloudfront functions. As of now AWS also have a very cool page with example <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/functions-example-code.html>cloudfront functions</a>.</p></div><div class=post-footer><div class=info></div></div></div></div></div></div><script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script><script async defer src=https://scripts.simpleanalyticscdn.com/latest.js></script><noscript><img src=https://queue.simpleanalyticscdn.com/noscript.gif alt></noscript></body></html>